<!doctype html>
<html lang="en">
<head>
<meta charset="UTF-8">
<script src="d3.js"></script>
<style>
body {
  font: 10px sans-serif;
}
#main {
  position: relative;
}
canvas {
  padding: 0;
  margin: 0;
}
svg {
  position: absolute;
  top: 0;
  bottom: 0;
}
.brush .extent {
  fill-opacity: .3;
  shape-rendering: crispEdges;
}
.resize rect {
  fill: #333;
  fill-opacity: .8;
  stroke: #555;
  stroke-width: 1.5px;
}
.histo {
  fill-opacity: .4;
  stroke-width: 2;
}
</style>
<title></title>
</head>
<body>
<div id="main"></div>
<script>
function load() {
  var image = this;

  var width = this.width,
      height = this.height,
      data = [];

  var brushsize = 5;
  var x = d3.scale.linear().range([0, width - brushsize]);
  var y = d3.scale.linear().range([brushsize, height - brushsize]);

  var rgb = d3.scale.ordinal().domain(d3.range(3)).range(["red", "green", "blue"])
  var xH = d3.scale.linear().domain([0, 255]).range([0, width]);
  var yH = d3.scale.linear().domain([0, 100]).range([10, 0]);

  var histo;

  function histogram(extent, context) {
    var x = width  *  extent[0][0],
        y = height *  extent[0][1],
        w = width  * (extent[1][0] - extent[0][0]),
        h = height * (extent[1][1] - extent[0][1]),
        p = context.getImageData(x, y, w, h).data,
        d = d3.range(3).map(Array);

    for (var i = 0; i < 256; i++) {
      d[0][i] = 0, d[1][i] = 0, d[2][i] = 0;
    }

    i = 0;
    do {
      d[0][p[i++]]++;
      d[1][p[i++]]++;
      d[2][p[i++]]++;
    } while(++i < p.length)

    return d;
  }

  function brushmove() {
    canvas.each(function() {
      data = histogram(brush.extent(), this.context);
      redraw();
    });
  }

  function draw() {
    histo = svg.selectAll(".histo")
      .data(data).enter()
      .append("path")
      .attr("class", "histo")
      .attr("d", area)
      .attr("fill", function(d, i) { return rgb(i); })
      .attr("stroke", function(d, i) { return rgb(i); });
  }

  function redraw() {
    histo.data(data).attr("d", area);
  }

  var area = d3.svg.area()
    .x(function(d, i) { return xH(i); })
    .y0(height)
    .y1(function(d) { return height + yH(d); })
    .interpolate("basis");

  var brush = d3.svg.brush()
    .x(x)
    .y(y)
    .extent([[.4, .4],[.6, .6]])
    .on("brush", brushmove);

  var svg = d3.select("#main")
    .append("svg")
      .attr("width", width)
      .attr("height", height)
    .append("g")

  var canvas = d3.select("#main")
    .append("canvas")
    .attr("width", width)
    .attr("height", height)
    .each(function() {
      this.context = this.getContext('2d');
      this.context.drawImage(image, 0, 0);
      data = histogram(brush.extent(), this.context);
      draw();
    });

  var brushg = svg.append("g")
    .attr("class", "brush")
    .call(brush);

  brushg.selectAll('rect');

  var resize = brushg.selectAll('.resize').select("rect")
    .attr("x", 0)
    .attr("y", 0)
    .attr("style", "");
}

document.addEventListener('DOMContentLoaded', function() {
  var image = new Image();
  image.src = 'l.jpg';
  image.addEventListener("load", load);
});
</script>
</body>
</html>
