<!doctype html>
<html lang="en">
<head>
<meta charset="UTF-8">
<script src="d3.js"></script>
<style>
body {
  font: 10px sans-serif;
}
#main {
  position: relative;
  width: 50%;
  margin: auto;
}
canvas {
  padding: 0;
  margin: 0;
}
svg {
  position: absolute;
  top: 0;
  bottom: 0;
}
.histo {
  fill-opacity: .4;
  stroke-width: 2;
}
</style>
<title></title>
</head>
<body>
<div id="main"></div>
<input type="checkbox" id="normalize">
<script>
'use strict';
function load() {
  var image  = this,
      width  = image.width,
      height = image.height,
      data   = [[]],

      rgb = d3.scale.ordinal().domain(d3.range(2)).range(["red", "blue"]),
      x = d3.scale.linear().domain([0, 255]).range([0, width]),
      y = d3.scale.linear().range([0, height / 4]);

  var svg, canvas, histo;

  var empty = Array(256);
  for (var i = 0; i < 256; i++) { empty[i] = 0; }

  function histogram(p) {
    var d = empty.slice();
    for (var i = 2; i < p.length; i += 4) {
      d[p[i]]++;
    }
    return d;
  }

  function normalize(p) {
    var H = histogram(p),
        c = cdf(H, p.length / 4);
    for (var i = 2; i < p.length; i += 4) {
      p[i] = (H.length - 1) * c[p[i]];
    }
    return p;
  }

  function cdf(histo, size) {
    return histo.reduce(function(cdf, v, i) {
      cdf.push((v / size + (cdf[i - 1] || 0)));
      return cdf;
    }, []);
  }

  var area = d3.svg.area()
    .x(function(d, i) { return x(i); })
    .y0(height)
    .y1(function(d) { return height - y(d); })
    .interpolate("basis");

  svg = d3.select("#main")
    .append("svg")
      .attr("width", width)
      .attr("height", height)
    .append("g")

  canvas = d3.select("#main")
    .append("canvas")
    .attr("width", width)
    .attr("height", height)
    .each(function() {
      this.context = this.getContext('2d');
      this.context.drawImage(image, 0, 0);
    })
    .each(function() {
      var p = this.context.getImageData(0, 0, width, height).data,
          H = histogram(p);
      y.domain([0, d3.max(H)]);
      data = [H];
      draw();
    });

  d3.select("#normalize").on("change", function() {
    var checked = this.checked;
    canvas.each(function() {
      var p = this.context.getImageData(0, 0, width, height).data,
          H = checked ? histogram(normalize(p)) : histogram(p);
      y.domain([0, d3.max(H)]);
      data = [H];
      redraw();
    })
  });

  function draw() {
    histo = svg.selectAll(".histo")
      .data(data).enter().append("path")
      .attr("class", "histo")
      .attr("fill", function(d, i) { return rgb(i); })
      .attr("stroke", function(d, i) { return rgb(i); })
      .attr("d", area);
  }

  function redraw() {
    histo.data(data)
      .transition()
      .duration(2000)
      .attr("d", area);
  }
}

document.addEventListener('DOMContentLoaded', function() {
  var image = new Image();
  image.src = 'l.jpg';
  image.addEventListener("load", load);
});
</script>
</body>
</html>
